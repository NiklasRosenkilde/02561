<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Worksheet 9-2</title>
  <h2>Worksheet 9-2</h2>

  <script type="text/javascript" src="../utils/webgl-utils.js"></script>
  <script type="text/javascript" src="../utils/webgl-debug.js"></script>

  <script type="text/javascript" src="../utils/initShaders.js"></script>
  <script type="text/javascript" src="../utils/MV.js"></script>
  <script type="text/javascript" src="../utils/OBJParser.js"></script>

  <script type="text/javascript" src="W9-2.js"></script>

  <!-- PART 2 - GROUND -->
  <script id="vertex-shader-ground" type="x-shader/x-vertex">
      attribute vec3 vertex_position;
      attribute vec2 texPosition;
      
      uniform mat4 modelView;
      uniform mat4 perspective;
      
      varying vec2 fTexCoord;
      varying vec3 fPosition;

      void main() {
          fPosition = vertex_position;
          fTexCoord = texPosition;
          gl_Position = perspective * modelView * vec4(vertex_position, 1);
      }
  </script>

  <script id="fragment-shader-ground" type="x-shader/x-fragment">
      precision mediump float;
      
      uniform mat4 lightModelView;
      uniform mat4 lightPerspective;
      
      varying vec2 fTexCoord;
      varying vec3 fPosition;
      
      uniform sampler2D texture;
      uniform sampler2D shadow;

      void main() {
          vec4 fPositionFromLight = lightPerspective * lightModelView * vec4(fPosition, 1);
          vec3 shadowCoord = (fPositionFromLight.xyz / fPositionFromLight.w) / 2.0 + 0.5;
          vec4 rgbaDepth = texture2D(shadow, shadowCoord.xy);
          float depth = rgbaDepth.r;
          float visibility = (shadowCoord.z > depth + 0.005) ? 0.5 : 1.0;

          vec4 origColor = texture2D(texture, fTexCoord);
          gl_FragColor = vec4(origColor.rgb * visibility, origColor.a);
      }
  </script>

  <!-- PART 2 - TEAPOT -->
  <script id="vertex-shader-teapot" type="x-shader/x-vertex">
      attribute vec3 vertex_position;
      attribute vec3 vertex_normal;
      attribute vec4 vertex_color;
      
      uniform mat4 modelView;
      uniform mat4 perspectiveMatrix;

      varying vec3 fPosition;
      varying vec4 fWorldPosition;
      varying vec3 fNormal;
      varying vec4 fColor;

      void main() {
          fPosition = vertex_position;
          fWorldPosition = modelView * vec4(vertex_position, 1);
          fNormal = vertex_normal;
          fColor = vertex_color;
          
          gl_Position = perspectiveMatrix * fWorldPosition;
      }
  </script>
  <script id="fragment-shader-teapot" type="x-shader/x-fragment">
      precision highp float;
      
      varying vec3 fPosition;
      varying vec4 fWorldPosition;
      varying vec3 fNormal;
      varying vec4 fColor;

      uniform mat4 lightModelView;
      uniform mat4 lightPerspective;
      uniform vec3 lightPosition;

      uniform sampler2D shadow;

      void main() {
          vec4 fPositionFromLight = lightPerspective * lightModelView * vec4(fPosition, 1);
          vec3 shadowCoord = (fPositionFromLight.xyz / fPositionFromLight.w) / 2.0 + 0.5;
          vec4 rgbaDepth = texture2D(shadow, shadowCoord.xy);
          float depth = rgbaDepth.r;
          float visibility = (shadowCoord.z > depth + 0.005) ? 0.5 : 1.0;

          // lambertian term
          vec3 L = normalize(lightPosition - fWorldPosition.xyz);
          float c = max(0.0, dot(fNormal.xyz, L));

          //gl_FragColor = vec4(vec3(c), fColor.a);
          gl_FragColor = vec4(vec3(c) * visibility, fColor.a);
      }
  </script>
  <!-- PART 2 - SHADOW -->
  <script id="vertex-shader-shadow" type="x-shader/x-vertex">
        attribute vec3 position;
        uniform mat4 modelView;
        uniform mat4 perspective;

        void main() {
            gl_Position = perspective * modelView * vec4(position, 1);
        }
    </script>
  <script id="fragment-shader-shadow" type="x-shader/x-fragment">
        precision highp float;

        void main() {
            gl_FragColor = vec4(vec3(gl_FragCoord.z), 1.0);
        }
    </script>
</head>

<!DOCTYPE html>
<html>

<body>
  <div>
    <div>Move teapot <input id="moveTeapot" type="checkbox" checked /></div>
    <div>Look down <input id="lookDown" type="checkbox" /></div>
    <div>Move light <input id="moveLight" type="checkbox" checked /></div>
  </div>

  <div class="row" width=764 style="margin-top:10px">
    <canvas id="c" height="764" width="764"></canvas>
  </div>

  <div class="row" style="width: 764px; margin-top:15px;"></div>



</body>

</html>